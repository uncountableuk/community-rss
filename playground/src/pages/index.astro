---
/**
 * Homepage — displays the article feed grid with tab navigation.
 *
 * Articles are loaded client-side from the /api/v1/articles endpoint.
 * Infinite scrolling loads additional pages as the user scrolls.
 *
 * Customise this page to fit your community's design.
 *
 * @route /
 */
import BaseLayout from '@community-rss/core/layouts/BaseLayout.astro';
import TabBar from '@community-rss/core/components/TabBar.astro';
import FeedGrid from '@community-rss/core/components/FeedGrid.astro';
---

<BaseLayout title="Community RSS">
  <main class="crss-homepage">
    <header class="crss-homepage__header">
      <h1 class="crss-homepage__title">Community RSS</h1>
    </header>

    <!-- Sign-up CTA shown only to unauthenticated / guest visitors -->
    <div id="crss-homepage-cta" style="display: none;" aria-live="polite">
      <div class="crss-homepage-cta__inner">
        <p class="crss-homepage-cta__text">
          Join the community to react, comment, and keep track of your favourite articles.
        </p>
        <div class="crss-homepage-cta__actions">
          <a href="/auth/signup" class="crss-btn crss-btn--cta">Create Account</a>
          <a href="/auth/signin" class="crss-btn crss-btn--cta-secondary">Sign In</a>
        </div>
      </div>
    </div>

    <TabBar />

    <!-- Initial empty grid — articles loaded client-side from the API -->
    <FeedGrid articles={[]} />

    <div id="crss-empty-state" class="crss-homepage__empty" style="display: none;">
      <p>No articles yet. Articles will appear here once feeds have been synced.</p>
    </div>

    <div id="crss-loading-state" class="crss-homepage__loading">
      <p>Loading articles...</p>
    </div>

    <div id="infinite-scroll-sentinel" class="crss-homepage__sentinel"></div>
  </main>
</BaseLayout>

<style>
  .crss-homepage {
    max-width: 1200px;
    margin: 0 auto;
    padding: var(--crss-space-lg) var(--crss-space-md);
  }

  .crss-homepage__header {
    margin-bottom: var(--crss-space-lg);
  }

  .crss-homepage__title {
    font-size: var(--crss-font-size-3xl);
    font-weight: 700;
    color: var(--crss-text-primary);
  }

  .crss-homepage__error,
  .crss-homepage__empty,
  .crss-homepage__loading {
    text-align: center;
    padding: var(--crss-space-3xl) var(--crss-space-md);
    color: var(--crss-text-muted);
    font-size: var(--crss-font-size-lg);
  }

  .crss-homepage__sentinel {
    height: 1px;
  }

  .crss-homepage-cta__inner {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
    gap: var(--crss-space-md);
    padding: var(--crss-space-md) var(--crss-space-lg);
    margin-bottom: var(--crss-space-lg);
    background-color: var(--crss-surface-1);
    border: 1px solid var(--crss-surface-3);
    border-radius: var(--crss-radius-lg);
  }

  .crss-homepage-cta__text {
    font-size: var(--crss-font-size-sm);
    color: var(--crss-text-secondary);
    margin: 0;
  }

  .crss-homepage-cta__actions {
    display: flex;
    align-items: center;
    gap: var(--crss-space-sm);
    flex-shrink: 0;
  }

  .crss-btn--cta {
    display: inline-flex;
    align-items: center;
    padding: var(--crss-space-xs) var(--crss-space-md);
    background-color: var(--crss-brand-primary);
    color: var(--crss-text-inverse);
    border-radius: var(--crss-radius-md);
    font-size: var(--crss-font-size-sm);
    font-family: var(--crss-font-family);
    text-decoration: none;
    transition: background-color var(--crss-transition-fast);
  }

  .crss-btn--cta:hover {
    background-color: var(--crss-brand-accent);
  }

  .crss-btn--cta-secondary {
    display: inline-flex;
    align-items: center;
    padding: var(--crss-space-xs) var(--crss-space-md);
    background-color: transparent;
    color: var(--crss-text-secondary);
    border: 1px solid var(--crss-surface-3);
    border-radius: var(--crss-radius-md);
    font-size: var(--crss-font-size-sm);
    font-family: var(--crss-font-family);
    text-decoration: none;
    transition:
      background-color var(--crss-transition-fast),
      color var(--crss-transition-fast);
  }

  .crss-btn--cta-secondary:hover {
    background-color: var(--crss-surface-2);
    color: var(--crss-text-primary);
  }
</style>

<script>
  // Show the sign-up CTA for unauthenticated or guest users
  (async () => {
    try {
      const res = await fetch('/api/auth/get-session', { credentials: 'include' });
      const data = res.ok ? await res.json() : null;
      const isAuthenticated = data?.user && !data.user.isGuest;
      if (!isAuthenticated) {
        const cta = document.getElementById('crss-homepage-cta');
        if (cta) cta.style.display = 'block';
      }
    } catch {
      // If session check fails, don't show the CTA to avoid noise
    }
  })();

  function createArticleCard(article: any): HTMLElement {
    const card = document.createElement('article');
    card.className = 'crss-feed-card';
    card.dataset.articleId = article.id;

    const link = document.createElement('a');
    link.href = `/article/${article.id}`;
    link.className = 'crss-feed-card__link';
    link.setAttribute('data-article-link', '');

    const header = document.createElement('header');
    header.className = 'crss-feed-card__header';

    if (article.feedTitle) {
      const source = document.createElement('span');
      source.className = 'crss-feed-card__source';
      source.textContent = article.feedTitle;
      header.appendChild(source);
    }

    if (article.publishedAt) {
      const time = document.createElement('time');
      time.className = 'crss-feed-card__date';
      time.textContent = new Date(article.publishedAt).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
      });
      header.appendChild(time);
    }

    const title = document.createElement('h3');
    title.className = 'crss-feed-card__title';
    title.textContent = article.title;

    link.appendChild(header);
    link.appendChild(title);

    if (article.summary) {
      const summary = document.createElement('p');
      summary.className = 'crss-feed-card__summary';
      summary.textContent = article.summary;
      link.appendChild(summary);
    }

    const footer = document.createElement('footer');
    footer.className = 'crss-feed-card__footer';

    const author = document.createElement('span');
    author.className = 'crss-feed-card__author';
    author.textContent = article.authorName || 'Unknown';

    const interactions = document.createElement('div');
    interactions.className = 'crss-feed-card__interactions';

    const heartsSpan = document.createElement('span');
    heartsSpan.className = 'crss-feed-card__hearts';
    heartsSpan.setAttribute('title', 'Hearts');
    heartsSpan.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg><span>${article.heartCount || 0}</span>`;

    const starsSpan = document.createElement('span');
    starsSpan.className = 'crss-feed-card__stars';
    starsSpan.setAttribute('title', 'Stars');
    starsSpan.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg><span>${article.starCount || 0}</span>`;

    interactions.appendChild(heartsSpan);
    interactions.appendChild(starsSpan);
    footer.appendChild(author);
    footer.appendChild(interactions);
    link.appendChild(footer);
    card.appendChild(link);

    return card;
  }

  // Load articles from the API
  const grid = document.getElementById('feed-grid');
  const loadingState = document.getElementById('crss-loading-state');
  const emptyState = document.getElementById('crss-empty-state');
  const sentinel = document.getElementById('infinite-scroll-sentinel');
  let currentPage = 1;
  let isLoading = false;
  let hasMore = true;

  async function loadArticles(page: number) {
    isLoading = true;
    try {
      const response = await fetch(`/api/v1/articles?page=${page}&limit=20`);
      const data = await response.json();

      if (loadingState) loadingState.style.display = 'none';

      if (data.data && data.data.length > 0) {
        for (const article of data.data) {
          grid?.appendChild(createArticleCard(article));
        }
        hasMore = data.pagination?.hasMore ?? false;
      } else if (page === 1) {
        if (emptyState) emptyState.style.display = 'block';
        hasMore = false;
      } else {
        hasMore = false;
      }
    } catch (e) {
      console.error('[community-rss] Failed to load articles:', e);
      if (loadingState && page === 1) {
        loadingState.querySelector('p')!.textContent =
          'Failed to load articles. Please try again later.';
      }
    }
    isLoading = false;
  }

  // Initial load
  loadArticles(1);

  // Infinite scroll
  if (sentinel && grid) {
    const observer = new IntersectionObserver(
      async (entries) => {
        if (entries[0].isIntersecting && !isLoading && hasMore) {
          currentPage++;
          await loadArticles(currentPage);
        }
      },
      { threshold: 0.1 },
    );
    observer.observe(sentinel);
  }
</script>
