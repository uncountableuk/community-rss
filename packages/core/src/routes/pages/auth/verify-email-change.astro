---
/**
 * Email change verification page.
 *
 * Reads the `token` query parameter, calls the confirm-email-change API,
 * and renders a success or error state. No server-side auth required —
 * the token acts as the credential for this single action.
 *
 * @route /auth/verify-email-change
 * @since 0.3.0
 */

import BaseLayout from '../../../layouts/BaseLayout.astro';
---

<BaseLayout title="Confirm Email Change" description="Verifying your new email address">
  <main class="crss-verify-page">
    <div class="crss-verify-container">

      <div id="state-loading" class="crss-verify-state">
        <div class="crss-verify-spinner" aria-hidden="true"></div>
        <p>Verifying your new email address…</p>
      </div>

      <div id="state-success" class="crss-verify-state" style="display: none;">
        <div class="crss-verify-icon crss-verify-icon--success" aria-hidden="true">✓</div>
        <h1 class="crss-verify-title">Email updated!</h1>
        <p class="crss-verify-body">Your email address has been changed successfully.</p>
        <a href="/profile" class="crss-btn crss-btn--primary">Back to Profile</a>
      </div>

      <div id="state-expired" class="crss-verify-state" style="display: none;">
        <div class="crss-verify-icon crss-verify-icon--warn" aria-hidden="true">⏱</div>
        <h1 class="crss-verify-title">Link expired</h1>
        <p class="crss-verify-body">
          This verification link has expired. Please visit your profile to request a new one.
        </p>
        <a href="/profile" class="crss-btn crss-btn--primary">Go to Profile</a>
      </div>

      <div id="state-invalid" class="crss-verify-state" style="display: none;">
        <div class="crss-verify-icon crss-verify-icon--error" aria-hidden="true">✗</div>
        <h1 class="crss-verify-title">Invalid link</h1>
        <p class="crss-verify-body">
          This verification link is invalid or has already been used. If you still need to change your
          email, please request a new link from your profile.
        </p>
        <a href="/profile" class="crss-btn crss-btn--primary">Go to Profile</a>
      </div>

      <div id="state-error" class="crss-verify-state" style="display: none;">
        <div class="crss-verify-icon crss-verify-icon--error" aria-hidden="true">✗</div>
        <h1 class="crss-verify-title">Something went wrong</h1>
        <p class="crss-verify-body">An unexpected error occurred. Please try again later.</p>
        <a href="/profile" class="crss-btn crss-btn--primary">Go to Profile</a>
      </div>

    </div>
  </main>
</BaseLayout>

<style>
  .crss-verify-page {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    padding: var(--crss-space-xl);
  }

  .crss-verify-container {
    max-width: 480px;
    width: 100%;
    text-align: center;
  }

  .crss-verify-state {
    animation: crss-fadein 0.2s ease;
  }

  @keyframes crss-fadein {
    from { opacity: 0; transform: translateY(8px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .crss-verify-icon {
    font-size: 3rem;
    line-height: 1;
    margin-bottom: var(--crss-space-md);
  }

  .crss-verify-icon--success { color: #059669; }
  .crss-verify-icon--warn    { color: #d97706; }
  .crss-verify-icon--error   { color: var(--crss-error); }

  .crss-verify-title {
    font-size: var(--crss-font-size-2xl);
    font-weight: 700;
    color: var(--crss-text-primary);
    margin-bottom: var(--crss-space-sm);
  }

  .crss-verify-body {
    color: var(--crss-text-secondary);
    margin-bottom: var(--crss-space-xl);
    line-height: 1.6;
  }

  .crss-verify-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--crss-surface-3);
    border-top-color: var(--crss-brand-primary);
    border-radius: 50%;
    animation: crss-spin 0.8s linear infinite;
    margin: 0 auto var(--crss-space-md);
  }

  @keyframes crss-spin {
    to { transform: rotate(360deg); }
  }

  .crss-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--crss-radius-md);
    font-size: var(--crss-font-size-base);
    font-family: var(--crss-font-family);
    cursor: pointer;
    text-decoration: none;
    transition: background-color var(--crss-transition-fast);
  }

  .crss-btn--primary {
    padding: var(--crss-space-sm) var(--crss-space-xl);
    background-color: var(--crss-brand-primary);
    color: var(--crss-text-inverse);
    border: none;
  }

  .crss-btn--primary:hover {
    background-color: var(--crss-brand-accent);
  }
</style>

<script>
  type VerifyState = 'success' | 'expired' | 'invalid' | 'error';

  function showState(state: VerifyState) {
    document.getElementById('state-loading')!.style.display = 'none';
    document.getElementById(`state-${state}`)!.style.display = 'block';
  }

  async function verifyToken() {
    const params = new URLSearchParams(window.location.search);
    const token = params.get('token');

    if (!token) {
      showState('invalid');
      return;
    }

    try {
      const response = await fetch(
        `/api/v1/profile/confirm-email-change?token=${encodeURIComponent(token)}`,
        { credentials: 'include' },
      );

      if (response.ok) {
        showState('success');
        return;
      }

      const data = await response.json().catch(() => ({})) as Record<string, string>;

      if (data.code === 'TOKEN_EXPIRED') {
        showState('expired');
      } else if (response.status === 404 || data.code === 'TOKEN_NOT_FOUND') {
        showState('invalid');
      } else {
        showState('error');
      }
    } catch {
      showState('error');
    }
  }

  verifyToken();
</script>
