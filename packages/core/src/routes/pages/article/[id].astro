---
/**
 * Article detail page — server-side rendered for direct URL access / SEO.
 *
 * When accessed directly (e.g., shared link), renders the full article.
 * When navigated to from the homepage, the client-side modal handles display.
 *
 * @since 0.2.0
 */
import BaseLayout from '../../../layouts/BaseLayout.astro';

const { id } = Astro.params;
const env = (Astro.locals as { runtime?: { env?: { DB?: D1Database } } }).runtime?.env;

let article: any = null;
let error = '';

if (!id) {
  error = 'Article not found.';
} else if (env?.DB) {
  try {
    const { getArticleById } = await import('../../../db/queries/articles');
    article = await getArticleById(env.DB, id);
    if (!article) {
      error = 'Article not found.';
    }
  } catch (e) {
    console.error('[community-rss] Failed to load article:', e);
    error = 'Failed to load article.';
  }
} else {
  error = 'Database not configured.';
}
---

<BaseLayout title={article?.title || 'Article'} description={article?.summary}>
  <main class="crss-article-page">
    {error ? (
      <div class="crss-article-page__error">
        <p>{error}</p>
        <a href="/">← Back to feed</a>
      </div>
    ) : article ? (
      <article class="crss-article">
        <header class="crss-article__header">
          <a href="/" class="crss-article__back">← Back to feed</a>
          <div class="crss-article__meta">
            {article.publishedAt && (
              <time datetime={new Date(article.publishedAt).toISOString()}>
                {new Date(article.publishedAt).toLocaleDateString('en-US', {
                  year: 'numeric',
                  month: 'long',
                  day: 'numeric',
                })}
              </time>
            )}
            <span>by {article.authorName || 'Unknown'}</span>
          </div>
          <h1 class="crss-article__title">{article.title}</h1>
        </header>

        <div class="crss-article__content" set:html={article.content} />

        <footer class="crss-article__footer">
          {article.originalLink && (
            <a
              href={article.originalLink}
              class="crss-article__original-link"
              target="_blank"
              rel="noopener noreferrer"
            >
              Read original article →
            </a>
          )}
        </footer>
      </article>
    ) : null}
  </main>
</BaseLayout>

<style>
  .crss-article-page {
    max-width: 800px;
    margin: 0 auto;
    padding: var(--crss-space-xl) var(--crss-space-md);
  }

  .crss-article-page__error {
    text-align: center;
    padding: var(--crss-space-3xl);
    color: var(--crss-text-muted);
  }

  .crss-article-page__error a {
    color: var(--crss-brand-primary);
    text-decoration: none;
    margin-top: var(--crss-space-md);
    display: inline-block;
  }

  .crss-article__back {
    color: var(--crss-brand-primary);
    text-decoration: none;
    font-size: var(--crss-font-size-sm);
    display: inline-block;
    margin-bottom: var(--crss-space-lg);
  }

  .crss-article__back:hover {
    text-decoration: underline;
  }

  .crss-article__meta {
    display: flex;
    gap: var(--crss-space-sm);
    font-size: var(--crss-font-size-sm);
    color: var(--crss-text-muted);
    margin-bottom: var(--crss-space-md);
  }

  .crss-article__title {
    font-size: var(--crss-font-size-3xl);
    font-weight: 700;
    line-height: 1.3;
    margin-bottom: var(--crss-space-xl);
    color: var(--crss-text-primary);
  }

  .crss-article__content {
    line-height: 1.7;
    font-size: var(--crss-font-size-base);
    color: var(--crss-text-secondary);
  }

  .crss-article__content :global(img) {
    max-width: 100%;
    height: auto;
    border-radius: var(--crss-radius-sm);
    margin: var(--crss-space-md) 0;
  }

  .crss-article__content :global(a) {
    color: var(--crss-brand-primary);
  }

  .crss-article__content :global(pre) {
    background: var(--crss-surface-1);
    padding: var(--crss-space-md);
    border-radius: var(--crss-radius-sm);
    overflow-x: auto;
    font-family: var(--crss-font-family-mono);
    font-size: var(--crss-font-size-sm);
  }

  .crss-article__content :global(blockquote) {
    border-left: 3px solid var(--crss-brand-primary);
    padding-left: var(--crss-space-md);
    margin: var(--crss-space-md) 0;
    color: var(--crss-text-muted);
    font-style: italic;
  }

  .crss-article__footer {
    margin-top: var(--crss-space-xl);
    padding-top: var(--crss-space-md);
    border-top: 1px solid var(--crss-surface-2);
  }

  .crss-article__original-link {
    color: var(--crss-brand-primary);
    text-decoration: none;
    font-weight: 500;
  }

  .crss-article__original-link:hover {
    text-decoration: underline;
  }
</style>
