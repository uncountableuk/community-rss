---
/**
 * Magic link verification landing page.
 *
 * When a user clicks the magic link in their email, they land here.
 * The client-side script reads the token and completes verification.
 *
 * @route /auth/verify
 */
import BaseLayout from '@community-rss/core/layouts/BaseLayout.astro';
---

<BaseLayout title="Verifying…" description="Verifying your magic link">
  <main class="crss-verify-page">
    <div class="crss-verify-container">
      <div id="verify-loading" class="crss-verify-state">
        <div class="crss-verify-spinner" aria-hidden="true"></div>
        <h1 class="crss-verify-title">Verifying your link…</h1>
        <p class="crss-verify-message">Please wait while we sign you in.</p>
      </div>

      <div id="verify-error" class="crss-verify-state" style="display: none;">
        <h1 class="crss-verify-title">Verification Failed</h1>
        <p id="verify-error-message" class="crss-verify-message">
          This link is invalid or has expired.
        </p>
        <a href="/auth/signin" class="crss-verify-link">Try signing in again</a>
      </div>
    </div>
  </main>
</BaseLayout>

<script>
  async function verifyMagicLink() {
    const params = new URLSearchParams(window.location.search);
    const token = params.get('token');
    const callbackURL = params.get('callbackURL') || '/';

    if (!token) {
      showError('No verification token found. Please request a new magic link.');
      return;
    }

    try {
      const verifyUrl = `/api/auth/magic-link/verify?token=${encodeURIComponent(token)}&callbackURL=${encodeURIComponent(callbackURL)}`;

      const res = await fetch(verifyUrl, {
        method: 'GET',
        credentials: 'include',
        redirect: 'follow',
      });

      if (res.ok) {
        window.location.href = callbackURL;
        return;
      }

      let errorMessage = 'This link is invalid or has expired.';
      const errorText = await res
        .clone()
        .text()
        .catch(() => '');

      try {
        const data = JSON.parse(errorText);
        errorMessage = data?.message || data?.error || errorMessage;
      } catch {
        errorMessage = errorText || `Server error (${res.status})`;
      }

      showError(errorMessage);
    } catch (err) {
      console.error('[community-rss] Magic link verification failed:', err);
      showError('An unexpected error occurred. Please try again.');
    }
  }

  function showError(message: string) {
    const loading = document.getElementById('verify-loading');
    const error = document.getElementById('verify-error');
    const errorMsg = document.getElementById('verify-error-message');

    if (loading) loading.style.display = 'none';
    if (error) error.style.display = 'block';
    if (errorMsg) errorMsg.textContent = message;
  }

  verifyMagicLink();
</script>

<style>
  .crss-verify-page {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: var(--crss-space-xl);
  }

  .crss-verify-container {
    max-width: 440px;
    width: 100%;
    text-align: center;
  }

  .crss-verify-title {
    font-size: var(--crss-font-size-2xl);
    font-weight: 700;
    color: var(--crss-text-primary);
    margin-bottom: var(--crss-space-sm);
  }

  .crss-verify-message {
    font-size: var(--crss-font-size-base);
    color: var(--crss-text-secondary);
    margin-bottom: var(--crss-space-lg);
  }

  .crss-verify-link {
    display: inline-block;
    padding: var(--crss-space-sm) var(--crss-space-lg);
    background: var(--crss-brand-primary);
    color: var(--crss-text-inverse);
    border-radius: var(--crss-radius-md);
    text-decoration: none;
    font-weight: 600;
    transition: opacity 0.2s;
  }

  .crss-verify-link:hover {
    opacity: 0.9;
  }

  .crss-verify-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--crss-surface-3);
    border-top-color: var(--crss-brand-primary);
    border-radius: 50%;
    margin: 0 auto var(--crss-space-lg);
    animation: crss-spin 0.8s linear infinite;
  }

  @keyframes crss-spin {
    to {
      transform: rotate(360deg);
    }
  }
</style>
