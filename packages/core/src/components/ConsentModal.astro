---
/**
 * Consent modal for guest interactions.
 *
 * Presented on first interaction (Heart, Star, or Comment) when the
 * user is not authenticated and has no guest session. Explains data
 * collection and creates a shadow profile on acceptance.
 *
 * @since 0.3.0
 */

interface Props {
  /** Configurable message strings. @since 0.4.0 */
  messages?: {
    title?: string;
    body?: string;
    detail?: string;
    acceptLabel?: string;
    declineLabel?: string;
  };
}

const {
  messages: {
    title: modalTitle = 'Before you interact\u2026',
    body: bodyText = 'To save your hearts, stars, and comments, we\u2019ll create an anonymous profile using a randomly generated ID stored in a cookie. No personal information is collected.',
    detail:
      detailText = 'You can register later to keep your interactions across devices. By continuing, you agree to our use of cookies for this purpose.',
    acceptLabel = 'Accept & Continue',
    declineLabel = 'No Thanks',
  } = {},
} = Astro.props;
---

<slot name="before-unnamed-slot" />
<div
  class="crss-consent-overlay"
  id="crss-consent-overlay"
  style="display: none;"
  role="dialog"
  aria-modal="true"
  aria-labelledby="crss-consent-title"
>
  <div class="crss-consent-modal">
    <h2 class="crss-consent-title" id="crss-consent-title">{modalTitle}</h2>
    <p class="crss-consent-text">
      {bodyText}
    </p>
    <p class="crss-consent-text crss-consent-text--secondary">
      {detailText}
    </p>
    <div class="crss-consent-actions">
      <button type="button" class="crss-btn crss-btn--accept" id="crss-consent-accept">
        {acceptLabel}
      </button>
      <button type="button" class="crss-btn crss-btn--decline" id="crss-consent-decline">
        {declineLabel}
      </button>
    </div>
  </div>
</div>
<slot />
<slot name="after-unnamed-slot" />

<style is:global>
  @layer crss-components {
    .crss-consent-overlay {
      position: fixed;
      inset: 0;
      z-index: 1000;
      background-color: var(--crss-comp-consent-overlay-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--crss-sys-space-md);
    }

    .crss-consent-modal {
      background-color: var(--crss-comp-consent-bg);
      border-radius: var(--crss-comp-consent-radius);
      padding: var(--crss-comp-consent-padding);
      max-width: var(--crss-comp-consent-max-width);
      width: 100%;
      box-shadow: var(--crss-comp-consent-shadow);
    }

    .crss-consent-title {
      font-size: var(--crss-comp-consent-title-size);
      font-weight: 600;
      color: var(--crss-sys-color-text-primary);
      margin-bottom: var(--crss-sys-space-md);
    }

    .crss-consent-text {
      font-size: var(--crss-font-size-base);
      color: var(--crss-text-secondary);
      line-height: 1.6;
      margin-bottom: var(--crss-space-sm);
    }

    .crss-consent-text--secondary {
      font-size: var(--crss-font-size-sm);
      color: var(--crss-text-muted);
      margin-bottom: var(--crss-space-lg);
    }

    .crss-consent-actions {
      display: flex;
      gap: var(--crss-space-sm);
      justify-content: flex-end;
    }

    .crss-btn--accept {
      padding: var(--crss-space-sm) var(--crss-space-lg);
      background-color: var(--crss-brand-primary);
      color: var(--crss-text-inverse);
      border: none;
      border-radius: var(--crss-radius-md);
      font-size: var(--crss-font-size-sm);
      cursor: pointer;
      transition: background-color var(--crss-transition-fast);
    }

    .crss-btn--accept:hover {
      background-color: var(--crss-brand-accent);
    }

    .crss-btn--decline {
      padding: var(--crss-space-sm) var(--crss-space-lg);
      background-color: transparent;
      color: var(--crss-text-muted);
      border: 1px solid var(--crss-surface-3);
      border-radius: var(--crss-radius-md);
      font-size: var(--crss-font-size-sm);
      cursor: pointer;
      transition: all var(--crss-transition-fast);
    }

    .crss-btn--decline:hover {
      background-color: var(--crss-surface-1);
      color: var(--crss-text-secondary);
    }
  }
</style>

<script>
  /**
   * Shows the consent modal and returns a promise that resolves
   * to the guest ID (on accept) or null (on decline).
   *
   * Called from interaction handlers (hearts, stars, comments)
   * when no session or guest cookie exists.
   */
  (window as any).__crssShowConsentModal = function showConsentModal(): Promise<string | null> {
    return new Promise((resolve) => {
      const overlay = document.getElementById('crss-consent-overlay');
      const acceptBtn = document.getElementById('crss-consent-accept');
      const declineBtn = document.getElementById('crss-consent-decline');

      if (!overlay || !acceptBtn || !declineBtn) {
        resolve(null);
        return;
      }

      overlay.style.display = 'flex';

      const cleanup = () => {
        overlay.style.display = 'none';
        acceptBtn.removeEventListener('click', onAccept);
        declineBtn.removeEventListener('click', onDecline);
      };

      const onAccept = async () => {
        // Delegate UUID generation and cookie setting to guest utility
        const { initGuestSession } = await import('../utils/client/guest');
        const guestId = initGuestSession();

        // Create shadow profile server-side
        try {
          await fetch('/api/v1/guest', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ guestId }),
          });
        } catch {
          // Shadow profile creation failure shouldn't block the interaction
          console.warn('[community-rss] Failed to create shadow profile');
        }

        cleanup();
        resolve(guestId);
      };

      const onDecline = () => {
        cleanup();
        resolve(null);
      };

      acceptBtn.addEventListener('click', onAccept);
      declineBtn.addEventListener('click', onDecline);
    });
  };
</script>
