---
/**
 * Auth button component â€” shows sign-in or sign-out based on session state.
 *
 * Performs a server-side session check via better-auth so that the
 * correct UI is rendered without client-side JavaScript. Designed to
 * be used with Astro's `server:defer` directive (Server Islands) so
 * the initial page shell loads instantly while auth state streams in.
 *
 * @example
 * ```astro
 * <AuthButton server:defer>
 *   <div slot="fallback" class="crss-auth-skeleton" aria-hidden="true"></div>
 * </AuthButton>
 * ```
 *
 * @since 0.3.0
 */

import { createAuth } from '../utils/build/auth';
import type { AppContext } from '../types/context';

interface Props {
  /** Configurable label strings. @since 0.4.0 */
  labels?: {
    signIn?: string;
    signOut?: string;
    profileLink?: string;
  };
}

const {
  labels: {
    signIn: signInLabel = 'Sign In',
    signOut: signOutLabel = 'Sign Out',
    profileLink: profileLinkText = '',
  } = {},
} = Astro.props;

// Server-side session check via better-auth
const app = (Astro.locals as Record<string, unknown>).app as AppContext | undefined;
let isAuthenticated = false;
let displayName = '';

if (app) {
  try {
    const auth = createAuth(app);
    const session = await auth.api.getSession({
      headers: Astro.request.headers,
    });
    if (session?.user && !(session.user as Record<string, unknown>).isGuest) {
      isAuthenticated = true;
      displayName = session.user.name || session.user.email || '';
    }
  } catch {
    /* default to sign-in button */
  }
}
---

<div class="crss-auth-button" id="crss-auth-button">
  {
    isAuthenticated ? (
      <div class="crss-auth-user" id="crss-user-info">
        <a href="/profile" class="crss-auth-user__name" id="crss-user-name">
          {displayName || profileLinkText || 'Profile'}
        </a>
        <button class="crss-btn crss-btn--signout" id="crss-signout-btn" type="button">
          {signOutLabel}
        </button>
      </div>
    ) : (
      <a href="/auth/signin" class="crss-btn crss-btn--signin" id="crss-signin-btn">
        {signInLabel}
      </a>
    )
  }
</div>

<style is:global>
  @layer crss-components {
    .crss-auth-button {
      display: flex;
      align-items: center;
      gap: var(--crss-comp-auth-gap);
    }

    .crss-btn {
      display: inline-flex;
      align-items: center;
      padding: var(--crss-comp-btn-padding-y) var(--crss-comp-btn-padding-x);
      background-color: var(--crss-comp-btn-bg);
      color: var(--crss-comp-btn-color);
      border-radius: var(--crss-comp-btn-radius);
      font-size: var(--crss-comp-btn-font-size);
      font-family: var(--crss-font-family);
      cursor: pointer;
      text-decoration: none;
      border: none;
      transition: var(--crss-comp-btn-transition);
    }

    .crss-btn--signin {
      background-color: var(--crss-comp-auth-signin-bg);
      color: var(--crss-comp-auth-signin-color);
    }

    .crss-btn--signin:hover {
      background-color: var(--crss-comp-btn-hover-bg);
    }

    .crss-btn--signout {
      background-color: var(--crss-comp-auth-signout-bg);
      color: var(--crss-comp-auth-signout-color);
      border: 1px solid var(--crss-comp-auth-signout-border);
    }

    .crss-btn--signout:hover {
      background-color: var(--crss-sys-color-surface-2);
    }

    .crss-auth-user {
      display: flex;
      align-items: center;
      gap: var(--crss-comp-auth-gap);
    }

    .crss-auth-user__name {
      font-size: var(--crss-comp-auth-btn-font-size);
      color: var(--crss-sys-color-text-secondary);
      text-decoration: none;
      transition: color var(--crss-sys-transition-fast);
    }

    .crss-auth-user__name:hover {
      color: var(--crss-sys-color-primary);
    }
  }
</style>

<script>
  async function signOut() {
    try {
      const response = await fetch('/api/auth/sign-out', {
        method: 'POST',
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({}),
      });

      if (!response.ok) {
        const errorText = await response.text();
        console.error(
          '[community-rss] Sign-out failed with status',
          response.status,
          ':',
          errorText,
        );
        return;
      }

      // Clear guest cookie on sign-out
      document.cookie = 'crss_guest=; path=/; max-age=0; samesite=lax';

      // Redirect to home
      window.location.href = '/';
    } catch (err) {
      console.error('[community-rss] Sign-out failed:', err);
    }
  }

  // Wire up sign-out button
  const signOutBtn = document.getElementById('crss-signout-btn');
  if (signOutBtn) {
    signOutBtn.addEventListener('click', (e) => {
      e.preventDefault();
      signOut();
    });
  }
</script>
